---
/**
 * Timeline - Vertical progress indicator with scroll-linked marker
 * Inspired by Tailwind Commit design
 * Uses Intersection Observer to track active section
 */
interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;
---

<div
  class:list={[
    'timeline-container pointer-events-none fixed inset-y-0 z-40 hidden lg:block',
    'right-[calc(max(2rem,50%-38rem)+40rem-0.375rem)]',
    className
  ]}
>
  <!-- Vertical dashed line -->
  <svg
    class="absolute inset-0 h-full w-1.5"
    aria-hidden="true"
  >
    <defs>
      <pattern id="timeline-dash" width="6" height="12" patternUnits="userSpaceOnUse">
        <line
          x1="3"
          y1="0"
          x2="3"
          y2="8"
          stroke="currentColor"
          stroke-width="1"
          class="text-primary/20"
        />
      </pattern>
      <linearGradient id="timeline-gradient" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="transparent" />
        <stop offset="10%" stop-color="currentColor" />
        <stop offset="90%" stop-color="currentColor" />
        <stop offset="100%" stop-color="transparent" />
      </linearGradient>
      <mask id="timeline-mask">
        <rect width="100%" height="100%" fill="url(#timeline-gradient)" />
      </mask>
    </defs>
    <rect
      width="100%"
      height="100%"
      fill="url(#timeline-dash)"
      mask="url(#timeline-mask)"
    />
  </svg>

  <!-- Scroll marker -->
  <div
    id="timeline-marker"
    class="absolute left-1/2 -translate-x-1/2 transition-all duration-300 ease-out"
    style="top: 20%;"
  >
    <!-- Glow effect -->
    <div class="absolute -inset-2 rounded-full bg-primary/30 blur-md"></div>

    <!-- Marker icon -->
    <div class="relative flex h-4 w-4 items-center justify-center rounded-full bg-primary shadow-lg ring-2 ring-primary/50">
      <div class="h-1.5 w-1.5 rounded-full bg-white"></div>
    </div>

    <!-- Active section indicator -->
    <div
      id="timeline-label"
      class="absolute left-6 top-1/2 -translate-y-1/2 whitespace-nowrap rounded bg-base-300/90 px-2 py-0.5 text-xs font-medium text-base-content opacity-0 transition-opacity duration-200"
    >
      Overview
    </div>
  </div>

  <!-- Progress fill (animated line showing how far down the page) -->
  <div
    id="timeline-progress"
    class="absolute left-1/2 top-0 w-0.5 -translate-x-1/2 bg-gradient-to-b from-primary/60 to-primary transition-all duration-100"
    style="height: 20%;"
  ></div>
</div>

<script>
  // Timeline scroll tracking
  document.addEventListener('DOMContentLoaded', () => {
    const marker = document.getElementById('timeline-marker');
    const label = document.getElementById('timeline-label');
    const progress = document.getElementById('timeline-progress');

    if (!marker || !label || !progress) return;

    // Get all sections with fade-in class as reference points
    const sections = document.querySelectorAll('section.fade-in');
    const sectionData: { el: Element; top: number; label: string }[] = [];

    // Build section data
    sections.forEach((section, index) => {
      const heading = section.querySelector('h2, h3');
      const sectionLabel = heading?.textContent?.trim() || `Section ${index + 1}`;
      sectionData.push({
        el: section,
        top: 0,
        label: sectionLabel
      });
    });

    // Update positions on resize
    const updatePositions = () => {
      sectionData.forEach((data, index) => {
        const rect = data.el.getBoundingClientRect();
        data.top = rect.top + window.scrollY;
      });
    };

    // Initial position update
    updatePositions();
    window.addEventListener('resize', updatePositions);

    // Scroll handler
    let ticking = false;
    const handleScroll = () => {
      if (ticking) return;

      ticking = true;
      requestAnimationFrame(() => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = Math.min(Math.max(scrollTop / docHeight, 0), 1);

        // Update progress line and marker position
        const minPercent = 10;
        const maxPercent = 90;
        const markerPercent = minPercent + (scrollPercent * (maxPercent - minPercent));

        marker.style.top = `${markerPercent}%`;
        progress.style.height = `${markerPercent}%`;

        // Find active section
        let activeSection = sectionData[0];
        const viewportMiddle = scrollTop + (window.innerHeight / 3);

        for (const data of sectionData) {
          if (data.top <= viewportMiddle) {
            activeSection = data;
          }
        }

        // Update label
        if (activeSection) {
          label.textContent = activeSection.label;
        }

        ticking = false;
      });
    };

    // Add scroll listener
    window.addEventListener('scroll', handleScroll, { passive: true });

    // Initial call
    handleScroll();

    // Show label on hover
    const container = marker.closest('.timeline-container');
    if (container) {
      container.addEventListener('mouseenter', () => {
        label.style.opacity = '1';
        container.classList.add('pointer-events-auto');
      });
      container.addEventListener('mouseleave', () => {
        label.style.opacity = '0';
        container.classList.remove('pointer-events-auto');
      });
    }
  });
</script>

<style>
  .timeline-container {
    width: 1.5rem;
  }

  #timeline-marker {
    will-change: top;
  }

  #timeline-progress {
    will-change: height;
  }
</style>
